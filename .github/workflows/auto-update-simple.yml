name: ðŸ¤– ROæ–‡ç« è‡ªåŠ¨æ›´æ–° (ç®€åŒ–ç‰ˆ)

on:
  schedule:
    # æ¯å¤©åŒ—äº¬æ—¶é—´ä¸Šåˆ10:00æ‰§è¡Œ (UTCæ—¶é—´2:00)
    - cron: '0 2 * * *'
  
  # æ”¯æŒæ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      force_update:
        description: 'å¼ºåˆ¶æ‰§è¡Œæ›´æ–°ï¼ˆå¿½ç•¥æ—¥æœŸæ£€æŸ¥ï¼‰'
        required: false
        default: false
        type: boolean

env:
  # ä»ŽGitHub SecretsèŽ·å–é£žä¹¦åº”ç”¨é…ç½®
  FEISHU_APP_ID: ${{ secrets.FEISHU_APP_ID }}
  FEISHU_APP_SECRET: ${{ secrets.FEISHU_APP_SECRET }}
  FEISHU_ACCESS_TOKEN: ${{ secrets.FEISHU_ACCESS_TOKEN }}
  FEISHU_REFRESH_TOKEN: ${{ secrets.FEISHU_REFRESH_TOKEN }}
  FEISHU_SPACE_TOKEN: ${{ secrets.FEISHU_SPACE_TOKEN }}
  FEISHU_SPACE_ID: ${{ secrets.FEISHU_SPACE_ID }}
  # å¾®ä¿¡ç™»å½•çŠ¶æ€
  WECHAT_COOKIES_B64: ${{ secrets.WECHAT_COOKIES_B64 }}
  WECHAT_USER_AGENT: ${{ secrets.WECHAT_USER_AGENT }}

jobs:
  auto-update:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
    - name: ðŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: ðŸ è®¾ç½®PythonçŽ¯å¢ƒ
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'
        
    - name: ðŸ“¦ å®‰è£…ä¾èµ–
      run: |
        pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: ðŸŒ å®‰è£…Chromeæµè§ˆå™¨
      run: |
        wget -q -O - https://dl.google.com/linux/linux_signing_key.pub | sudo apt-key add -
        sudo sh -c 'echo "deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main" >> /etc/apt/sources.list.d/google-chrome.list'
        sudo apt-get update
        sudo apt-get install -y google-chrome-stable
        
    - name: ðŸ”§ é…ç½®è™šæ‹Ÿæ˜¾ç¤ºå™¨
      run: |
        sudo apt-get install -y xvfb
        export DISPLAY=:99
        Xvfb :99 -screen 0 1920x1080x24 > /dev/null 2>&1 &
        
    - name: ðŸ“ åˆ›å»ºå¿…è¦ç›®å½•
      run: |
        mkdir -p output/auto_download
        mkdir -p logs
        
    - name: ðŸ” é…ç½®é£žä¹¦è®¤è¯ä¿¡æ¯å’Œå¾®ä¿¡ç™»å½•çŠ¶æ€
      run: |
        # åˆ›å»ºé£žä¹¦OAuthä»¤ç‰Œæ–‡ä»¶
        cat > feishu_oauth_tokens.json << EOF
        {
          "access_token": "${{ secrets.FEISHU_ACCESS_TOKEN }}",
          "refresh_token": "${{ secrets.FEISHU_REFRESH_TOKEN }}",
          "expires_in": 6900,
          "token_type": "Bearer",
          "scope": null,
          "created_at": $(date +%s),
          "app_id": "${{ secrets.FEISHU_APP_ID }}"
        }
        EOF
        
        # åˆ›å»ºå¾®ä¿¡ç™»å½•çŠ¶æ€æ–‡ä»¶
        if [ -n "${{ secrets.WECHAT_COOKIES_B64 }}" ]; then
          echo "ðŸ” æ¢å¤å¾®ä¿¡ç™»å½•çŠ¶æ€..."
          echo "${{ secrets.WECHAT_COOKIES_B64 }}" | base64 -d > wechat_cookies.pkl
          
          cat > wechat_session.json << EOF
        {
          "user_agent": "${{ secrets.WECHAT_USER_AGENT }}",
          "timestamp": $(date +%s),
          "login_success": true,
          "restored_from_github": true
        }
        EOF
          echo "âœ… å¾®ä¿¡ç™»å½•çŠ¶æ€å·²æ¢å¤"
        else
          echo "âš ï¸ æœªæ‰¾åˆ°å¾®ä¿¡ç™»å½•çŠ¶æ€ï¼Œå¯èƒ½éœ€è¦é‡æ–°ç™»å½•"
        fi
        
        # åˆ›å»ºç”¨æˆ·é…ç½®æ–‡ä»¶
        cat > user_feishu_config.json << EOF
        {
          "app_id": "${{ secrets.FEISHU_APP_ID }}",
          "app_secret": "${{ secrets.FEISHU_APP_SECRET }}",
          "access_token": "${{ secrets.FEISHU_ACCESS_TOKEN }}",
          "space_token": "${{ secrets.FEISHU_SPACE_TOKEN }}",
          "space_id": "${{ secrets.FEISHU_SPACE_ID }}",
          "space_name": "ä»™å¢ƒä¼ è¯´ROæ–°å¯èˆªå…¬ä¼—å·æ–‡ç« åˆé›†",
          "api_base": "https://open.feishu.cn/open-apis",
          "mode": "user_complete",
          "test_success": true,
          "test_time": "$(date '+%Y-%m-%d %H:%M:%S')",
          "capabilities": {
            "çŸ¥è¯†åº“æƒé™": true,
            "äº‘æ–‡æ¡£æƒé™": true,
            "æ–‡ä»¶ä¸Šä¼ æƒé™": true,
            "å®Œæ•´ä¸Šä¼ æµç¨‹": true
          }
        }
        EOF
        
        # åˆ›å»ºè‡ªåŠ¨æ›´æ–°è®¾ç½®æ–‡ä»¶
        cat > ro_auto_update_settings.json << EOF
        {
          "auto_update_enabled": true,
          "last_update_date": "$(date -d '1 day ago' '+%Y-%m-%d')",
          "timer_enabled": false,
          "timer_interval": 1440
        }
        EOF
        
    - name: ðŸ§ª è°ƒè¯•å¯¼å…¥é—®é¢˜
      run: |
        export DISPLAY=:99
        python workflow_debug.py
        
    - name: ðŸ¤– æ‰§è¡ŒROè‡ªåŠ¨æ›´æ–° (ç®€åŒ–ç‰ˆ)
      run: |
        export DISPLAY=:99
        python -c "
        print('ðŸš€ ç®€åŒ–ç‰ˆè‡ªåŠ¨æ›´æ–°å¼€å§‹')
        print('=' * 50)
        
        # åŸºç¡€å¯¼å…¥æµ‹è¯•
        try:
            import sys
            import os
            import json
            from datetime import datetime, timedelta
            print('âœ… åŸºç¡€æ¨¡å—å¯¼å…¥æˆåŠŸ')
        except Exception as e:
            print(f'âŒ åŸºç¡€æ¨¡å—å¯¼å…¥å¤±è´¥: {e}')
            sys.exit(1)
        
        # æ£€æŸ¥æ–‡ä»¶å­˜åœ¨æ€§
        required_files = ['headless_wechat_collector.py', 'integrated_auto_download_uploader.py']
        for file in required_files:
            if os.path.exists(file):
                print(f'âœ… æ–‡ä»¶å­˜åœ¨: {file}')
            else:
                print(f'âŒ æ–‡ä»¶ä¸å­˜åœ¨: {file}')
                sys.exit(1)
        
        # å°è¯•å¯¼å…¥è‡ªå®šä¹‰æ¨¡å—
        try:
            sys.path.insert(0, '.')
            exec(open('headless_wechat_collector.py').read())
            print('âœ… HeadlessWeChatCollector æ¨¡å—åŠ è½½æˆåŠŸ')
        except Exception as e:
            print(f'âŒ HeadlessWeChatCollector åŠ è½½å¤±è´¥: {e}')
            import traceback
            traceback.print_exc()
            sys.exit(1)
            
        try:
            exec(open('integrated_auto_download_uploader.py').read())
            print('âœ… IntegratedAutoUploader æ¨¡å—åŠ è½½æˆåŠŸ')
        except Exception as e:
            print(f'âŒ IntegratedAutoUploader åŠ è½½å¤±è´¥: {e}')
            import traceback
            traceback.print_exc()
            sys.exit(1)
        
        print('ðŸŽ‰ æ‰€æœ‰æ¨¡å—åŠ è½½æˆåŠŸï¼')
        print('ðŸ’¡ å¦‚æžœæ­¤æ­¥éª¤æˆåŠŸï¼Œè¯´æ˜Žå¯¼å…¥é—®é¢˜å·²è§£å†³')
        "
        
    - name: ðŸ“Š ä¸Šä¼ æ‰§è¡Œæ—¥å¿—
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: auto-update-simple-logs-${{ github.run_number }}
        path: |
          logs/
          ro_auto_update_settings.json
        retention-days: 7 