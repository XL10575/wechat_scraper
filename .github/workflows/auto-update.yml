name: ğŸ¤– ROæ–‡ç« è‡ªåŠ¨æ›´æ–°

on:
  schedule:
    # æ¯å¤©åŒ—äº¬æ—¶é—´ä¸Šåˆ10:00æ‰§è¡Œ (UTCæ—¶é—´2:00)
    - cron: '0 2 * * *'
  
  # æ”¯æŒæ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      force_update:
        description: 'å¼ºåˆ¶æ‰§è¡Œæ›´æ–°ï¼ˆå¿½ç•¥æ—¥æœŸæ£€æŸ¥ï¼‰'
        required: false
        default: false
        type: boolean

env:
  # ä»GitHub Secretsè·å–é£ä¹¦åº”ç”¨é…ç½®
  FEISHU_APP_ID: ${{ secrets.FEISHU_APP_ID }}
  FEISHU_APP_SECRET: ${{ secrets.FEISHU_APP_SECRET }}
  FEISHU_ACCESS_TOKEN: ${{ secrets.FEISHU_ACCESS_TOKEN }}
  FEISHU_REFRESH_TOKEN: ${{ secrets.FEISHU_REFRESH_TOKEN }}
  FEISHU_SPACE_TOKEN: ${{ secrets.FEISHU_SPACE_TOKEN }}
  FEISHU_SPACE_ID: ${{ secrets.FEISHU_SPACE_ID }}
  # å¾®ä¿¡ç™»å½•çŠ¶æ€
  WECHAT_COOKIES_B64: ${{ secrets.WECHAT_COOKIES_B64 }}
  WECHAT_USER_AGENT: ${{ secrets.WECHAT_USER_AGENT }}

jobs:
  auto-update:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: ğŸ è®¾ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'
        
    - name: ğŸ“¦ å®‰è£…ä¾èµ–
      run: |
        pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: ğŸŒ å®‰è£…Chromeæµè§ˆå™¨
      run: |
        wget -q -O - https://dl.google.com/linux/linux_signing_key.pub | sudo apt-key add -
        sudo sh -c 'echo "deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main" >> /etc/apt/sources.list.d/google-chrome.list'
        sudo apt-get update
        sudo apt-get install -y google-chrome-stable
        
    - name: ğŸ”§ é…ç½®è™šæ‹Ÿæ˜¾ç¤ºå™¨
      run: |
        sudo apt-get install -y xvfb
        export DISPLAY=:99
        Xvfb :99 -screen 0 1920x1080x24 > /dev/null 2>&1 &
        
    - name: ğŸ“ åˆ›å»ºå¿…è¦ç›®å½•
      run: |
        mkdir -p output/auto_download
        mkdir -p logs
        
    - name: ğŸ” é…ç½®é£ä¹¦è®¤è¯ä¿¡æ¯å’Œå¾®ä¿¡ç™»å½•çŠ¶æ€
      run: |
        # åˆ›å»ºé£ä¹¦OAuthä»¤ç‰Œæ–‡ä»¶
        cat > feishu_oauth_tokens.json << EOF
        {
          "access_token": "${{ secrets.FEISHU_ACCESS_TOKEN }}",
          "refresh_token": "${{ secrets.FEISHU_REFRESH_TOKEN }}",
          "expires_in": 6900,
          "token_type": "Bearer",
          "scope": null,
          "created_at": $(date +%s),
          "app_id": "${{ secrets.FEISHU_APP_ID }}"
        }
        EOF
        
        # åˆ›å»ºå¾®ä¿¡ç™»å½•çŠ¶æ€æ–‡ä»¶
        if [ -n "${{ secrets.WECHAT_COOKIES_B64 }}" ]; then
          echo "ğŸ” æ¢å¤å¾®ä¿¡ç™»å½•çŠ¶æ€..."
          echo "${{ secrets.WECHAT_COOKIES_B64 }}" | base64 -d > wechat_cookies.pkl
          
          cat > wechat_session.json << EOF
        {
          "user_agent": "${{ secrets.WECHAT_USER_AGENT }}",
          "timestamp": $(date +%s),
          "login_success": true,
          "restored_from_github": true
        }
        EOF
          echo "âœ… å¾®ä¿¡ç™»å½•çŠ¶æ€å·²æ¢å¤"
        else
          echo "âš ï¸ æœªæ‰¾åˆ°å¾®ä¿¡ç™»å½•çŠ¶æ€ï¼Œå¯èƒ½éœ€è¦é‡æ–°ç™»å½•"
        fi
        
        # åˆ›å»ºç”¨æˆ·é…ç½®æ–‡ä»¶
        cat > user_feishu_config.json << EOF
        {
          "app_id": "${{ secrets.FEISHU_APP_ID }}",
          "app_secret": "${{ secrets.FEISHU_APP_SECRET }}",
          "access_token": "${{ secrets.FEISHU_ACCESS_TOKEN }}",
          "space_token": "${{ secrets.FEISHU_SPACE_TOKEN }}",
          "space_id": "${{ secrets.FEISHU_SPACE_ID }}",
          "space_name": "ä»™å¢ƒä¼ è¯´ROæ–°å¯èˆªå…¬ä¼—å·æ–‡ç« åˆé›†",
          "api_base": "https://open.feishu.cn/open-apis",
          "mode": "user_complete",
          "test_success": true,
          "test_time": "$(date '+%Y-%m-%d %H:%M:%S')",
          "capabilities": {
            "çŸ¥è¯†åº“æƒé™": true,
            "äº‘æ–‡æ¡£æƒé™": true,
            "æ–‡ä»¶ä¸Šä¼ æƒé™": true,
            "å®Œæ•´ä¸Šä¼ æµç¨‹": true
          }
        }
        EOF
        
        # åˆ›å»ºè‡ªåŠ¨æ›´æ–°è®¾ç½®æ–‡ä»¶
        cat > ro_auto_update_settings.json << EOF
        {
          "auto_update_enabled": true,
          "last_update_date": "$(date -d '1 day ago' '+%Y-%m-%d')",
          "timer_enabled": false,
          "timer_interval": 1440
        }
        EOF
        
    - name: ğŸ¤– æ‰§è¡ŒROè‡ªåŠ¨æ›´æ–°
      run: |
        export DISPLAY=:99
        python -c "
        import sys
        import os
        import json
        from datetime import datetime, timedelta
        from integrated_auto_download_uploader import IntegratedAutoUploader
        from headless_wechat_collector import HeadlessWeChatCollector
        
        print('ğŸš€ GitHub Actions - ROæ–‡ç« è‡ªåŠ¨æ›´æ–°å¼€å§‹')
        print('=' * 60)
        
        try:
            # åˆå§‹åŒ–é…ç½®
            app_id = os.getenv('FEISHU_APP_ID')
            app_secret = os.getenv('FEISHU_APP_SECRET')
            
            if not app_id or not app_secret:
                print('âŒ é£ä¹¦åº”ç”¨é…ç½®ç¼ºå¤±ï¼Œè¯·æ£€æŸ¥GitHub Secrets')
                sys.exit(1)
                
            print(f'âœ… é£ä¹¦åº”ç”¨é…ç½®å·²åŠ è½½')
            
            # æ­¥éª¤1: è®¡ç®—æ›´æ–°æ—¥æœŸèŒƒå›´
            print('ğŸ“… æ­¥éª¤1: è®¡ç®—æ›´æ–°æ—¥æœŸèŒƒå›´...')
            
            # è¯»å–ä¸Šæ¬¡æ›´æ–°æ—¥æœŸ
            try:
                with open('ro_auto_update_settings.json', 'r') as f:
                    settings = json.load(f)
                    last_date = settings.get('last_update_date')
            except:
                last_date = (datetime.now() - timedelta(days=1)).strftime('%Y-%m-%d')
            
            # è·å–ä»Šå¤©æ—¥æœŸ
            today = datetime.now().strftime('%Y-%m-%d')
            
            # å¦‚æœæ˜¯æ‰‹åŠ¨å¼ºåˆ¶æ›´æ–°ï¼Œæ‰©å¤§æ—¥æœŸèŒƒå›´
            force_update = '${{ github.event.inputs.force_update }}' == 'true'
            if force_update:
                print('ğŸ”„ æ£€æµ‹åˆ°å¼ºåˆ¶æ›´æ–°æ¨¡å¼ï¼Œæ‰©å¤§æ—¥æœŸèŒƒå›´')
                start_date = (datetime.now() - timedelta(days=7)).strftime('%Y-%m-%d')
            else:
                start_date = last_date
                
            end_date = today
            
            print(f'ğŸ“… æ›´æ–°æ—¥æœŸèŒƒå›´: {start_date} è‡³ {end_date}')
            
            # æ­¥éª¤2: ä½¿ç”¨æ— å¤´æ”¶é›†å™¨è‡ªåŠ¨æ”¶é›†æ–‡ç« 
            print('ğŸ” æ­¥éª¤2: è‡ªåŠ¨æ”¶é›†å¾®ä¿¡æ–‡ç« ...')
            
            try:
                # åˆå§‹åŒ–æ— å¤´æ”¶é›†å™¨
                collector = HeadlessWeChatCollector()
                
                # è®¡ç®—æ”¶é›†å¤©æ•°
                if force_update:
                    days_back = 7  # å¼ºåˆ¶æ›´æ–°æ—¶æ”¶é›†ä¸€å‘¨çš„æ–‡ç« 
                else:
                    # è®¡ç®—è‡ªä¸Šæ¬¡æ›´æ–°ä»¥æ¥çš„å¤©æ•°
                    try:
                        last_date_obj = datetime.strptime(last_date, '%Y-%m-%d')
                        days_back = (datetime.now() - last_date_obj).days + 1
                        days_back = min(days_back, 30)  # æœ€å¤š30å¤©
                    except:
                        days_back = 1  # é»˜è®¤1å¤©
                
                print(f'ğŸ“… æ”¶é›†èŒƒå›´: æœ€è¿‘ {days_back} å¤©çš„æ–‡ç« ')
                
                # è‡ªåŠ¨æ”¶é›†æ–‡ç« 
                articles = collector.auto_collect_articles(
                    account_name='ä»™å¢ƒä¼ è¯´ROæ–°å¯èˆª',
                    days_back=days_back,
                    max_articles=50
                )
                
                print(f'ğŸ“Š æ”¶é›†åˆ° {len(articles)} ç¯‡æ–‡ç« ')
                
                if len(articles) == 0:
                    print('âœ… æ²¡æœ‰æ–°æ–‡ç« éœ€è¦æ›´æ–°')
                    # æ›´æ–°æœ€åæ£€æŸ¥æ—¥æœŸ
                    settings = {}
                    try:
                        with open('ro_auto_update_settings.json', 'r') as f:
                            settings = json.load(f)
                    except:
                        settings = {}
                        
                    settings['last_update_date'] = today
                    settings['last_check_time'] = datetime.now().isoformat()
                    settings['status'] = 'no_new_articles'
                    
                    with open('ro_auto_update_settings.json', 'w') as f:
                        json.dump(settings, f, indent=2, ensure_ascii=False)
                    
                    print('âœ… è‡ªåŠ¨æ›´æ–°æ£€æŸ¥å®Œæˆï¼ˆæ— æ–°æ–‡ç« ï¼‰')
                    sys.exit(0)
                    
            except Exception as e:
                print(f'âŒ æ”¶é›†æ–‡ç« æ—¶å‡ºé”™: {e}')
                print('ğŸ’¡ å¯èƒ½çš„åŸå› ï¼š')
                print('   1. å¾®ä¿¡ç™»å½•çŠ¶æ€å·²è¿‡æœŸï¼Œéœ€è¦é‡æ–°ç”Ÿæˆsecrets')
                print('   2. ç½‘ç»œè¿æ¥é—®é¢˜')
                print('   3. å¾®ä¿¡APIå˜æ›´')
                
                # è®°å½•é”™è¯¯å¹¶é€€å‡º
                settings = {}
                try:
                    with open('ro_auto_update_settings.json', 'r') as f:
                        settings = json.load(f)
                except:
                    settings = {}
                    
                settings['last_check_time'] = datetime.now().isoformat()
                settings['status'] = 'collection_failed'
                settings['error'] = str(e)
                
                with open('ro_auto_update_settings.json', 'w') as f:
                    json.dump(settings, f, indent=2, ensure_ascii=False)
                
                sys.exit(1)
            
            # æ­¥éª¤3: å¤„ç†æ–‡ç« ä¸‹è½½ä¸Šä¼ 
            print(f'ğŸ“š æ­¥éª¤3: å¤„ç†æ–‡ç« ä¸‹è½½ä¸Šä¼ ...')
            
            uploader = IntegratedAutoUploader(app_id, app_secret)
            
            success_count = 0
            total_count = len(articles)
            
            for i, article in enumerate(articles, 1):
                url = article.get('url')
                title = article.get('title', f'æ–‡ç« {i}')
                
                print(f'ğŸ“„ å¤„ç† {i}/{total_count}: {title[:30]}...')
                print(f'   URL: {url[:80]}...')
                
                try:
                    result = uploader.process_single_url(url, format_type='pdf')
                    if result:
                        success_count += 1
                        print(f'   âœ… æˆåŠŸä¸Šä¼ åˆ°é£ä¹¦')
                    else:
                        print(f'   âŒ ä¸Šä¼ å¤±è´¥')
                except Exception as e:
                    print(f'   âŒ å¤„ç†å‡ºé”™: {e}')
                    
                # é¿å…è¿‡å¿«è¯·æ±‚
                if i < total_count:
                    print(f'   â³ ç­‰å¾… 3 ç§’...')
                    import time
                    time.sleep(3)
                    
            print(f'ğŸ“Š å¤„ç†å®Œæˆ: {success_count}/{total_count} æˆåŠŸ')
            
            # æ­¥éª¤4: æ›´æ–°è®¾ç½®
            print('ğŸ“… æ­¥éª¤4: æ›´æ–°æ£€æŸ¥æ—¥æœŸ...')
            
            # é‡æ–°è¯»å–è®¾ç½®ï¼ˆå¯èƒ½åœ¨å‰é¢è¢«ä¿®æ”¹ï¼‰
            try:
                with open('ro_auto_update_settings.json', 'r') as f:
                    settings = json.load(f)
            except:
                settings = {}
                
            settings['last_update_date'] = today
            settings['last_check_time'] = datetime.now().isoformat()
            settings['processed_count'] = success_count
            settings['total_count'] = total_count
            settings['status'] = 'completed'
            settings['articles_collected'] = len(articles)
            settings['success_rate'] = f'{success_count}/{total_count}' if total_count > 0 else '0/0'
            
            with open('ro_auto_update_settings.json', 'w') as f:
                json.dump(settings, f, indent=2, ensure_ascii=False)
            
            print(f'ğŸ‰ ROè‡ªåŠ¨æ›´æ–°å®Œæˆï¼')
            print(f'ğŸ“Š æ”¶é›†æ–‡ç« : {len(articles)} ç¯‡')
            print(f'ğŸ“Š æˆåŠŸä¸Šä¼ : {success_count}/{total_count} ç¯‡')
            print(f'ğŸ“Š æˆåŠŸç‡: {success_count/total_count*100:.1f}%' if total_count > 0 else 'ğŸ“Š æˆåŠŸç‡: 0%')
            
        except Exception as e:
            print(f'âŒ è‡ªåŠ¨æ›´æ–°æ‰§è¡Œå¤±è´¥: {e}')
            import traceback
            traceback.print_exc()
            sys.exit(1)
        "
        
    - name: ğŸ“Š ä¸Šä¼ æ‰§è¡Œæ—¥å¿—
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: auto-update-logs-${{ github.run_number }}
        path: |
          logs/
          ro_auto_update_settings.json
          integrated_upload_log.json
        retention-days: 7
        
    - name: ğŸ“§ å‘é€é€šçŸ¥ï¼ˆå¯é€‰ï¼‰
      if: failure()
      run: |
        echo "âš ï¸ ROè‡ªåŠ¨æ›´æ–°å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ‰§è¡Œæ—¥å¿—"
        # è¿™é‡Œå¯ä»¥æ·»åŠ é‚®ä»¶æˆ–å…¶ä»–é€šçŸ¥é€»è¾‘ 