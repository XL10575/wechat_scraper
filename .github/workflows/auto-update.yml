name: ðŸ¤– ROæ–‡ç« è‡ªåŠ¨æ›´æ–°

on:
  schedule:
    # æ¯å¤©åŒ—äº¬æ—¶é—´ä¸Šåˆ10:00æ‰§è¡Œ (UTCæ—¶é—´2:00)
    - cron: '0 2 * * *'
  
  # æ”¯æŒæ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      force_update:
        description: 'å¼ºåˆ¶æ‰§è¡Œæ›´æ–°ï¼ˆå¿½ç•¥æ—¥æœŸæ£€æŸ¥ï¼‰'
        required: false
        default: false
        type: boolean

env:
  # ä»ŽGitHub SecretsèŽ·å–é£žä¹¦åº”ç”¨é…ç½®
  FEISHU_APP_ID: ${{ secrets.FEISHU_APP_ID }}
  FEISHU_APP_SECRET: ${{ secrets.FEISHU_APP_SECRET }}
  FEISHU_ACCESS_TOKEN: ${{ secrets.FEISHU_ACCESS_TOKEN }}
  FEISHU_REFRESH_TOKEN: ${{ secrets.FEISHU_REFRESH_TOKEN }}

jobs:
  auto-update:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
    - name: ðŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: ðŸ è®¾ç½®PythonçŽ¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        cache: 'pip'
        
    - name: ðŸ“¦ å®‰è£…ä¾èµ–
      run: |
        pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: ðŸŒ å®‰è£…Chromeæµè§ˆå™¨
      run: |
        wget -q -O - https://dl.google.com/linux/linux_signing_key.pub | sudo apt-key add -
        sudo sh -c 'echo "deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main" >> /etc/apt/sources.list.d/google-chrome.list'
        sudo apt-get update
        sudo apt-get install -y google-chrome-stable
        
    - name: ðŸ”§ é…ç½®è™šæ‹Ÿæ˜¾ç¤ºå™¨
      run: |
        sudo apt-get install -y xvfb
        export DISPLAY=:99
        Xvfb :99 -screen 0 1920x1080x24 > /dev/null 2>&1 &
        
    - name: ðŸ“ åˆ›å»ºå¿…è¦ç›®å½•
      run: |
        mkdir -p output/auto_download
        mkdir -p logs
        
    - name: ðŸ” é…ç½®é£žä¹¦è®¤è¯ä¿¡æ¯
      run: |
        # åˆ›å»ºé£žä¹¦OAuthä»¤ç‰Œæ–‡ä»¶
        cat > feishu_oauth_tokens.json << EOF
        {
          "access_token": "${{ secrets.FEISHU_ACCESS_TOKEN }}",
          "refresh_token": "${{ secrets.FEISHU_REFRESH_TOKEN }}",
          "expires_in": 6900,
          "token_type": "Bearer",
          "scope": null,
          "created_at": $(date +%s),
          "app_id": "${{ secrets.FEISHU_APP_ID }}"
        }
        EOF
        
        # åˆ›å»ºç”¨æˆ·é…ç½®æ–‡ä»¶
        cat > user_feishu_config.json << EOF
        {
          "app_id": "${{ secrets.FEISHU_APP_ID }}",
          "app_secret": "${{ secrets.FEISHU_APP_SECRET }}",
          "access_token": "${{ secrets.FEISHU_ACCESS_TOKEN }}",
          "space_token": "${{ secrets.FEISHU_SPACE_TOKEN }}",
          "space_id": "${{ secrets.FEISHU_SPACE_ID }}",
          "space_name": "ä»™å¢ƒä¼ è¯´ROæ–°å¯èˆªå…¬ä¼—å·æ–‡ç« åˆé›†",
          "api_base": "https://open.feishu.cn/open-apis",
          "mode": "user_complete",
          "test_success": true,
          "test_time": "$(date '+%Y-%m-%d %H:%M:%S')",
          "capabilities": {
            "çŸ¥è¯†åº“æƒé™": true,
            "äº‘æ–‡æ¡£æƒé™": true,
            "æ–‡ä»¶ä¸Šä¼ æƒé™": true,
            "å®Œæ•´ä¸Šä¼ æµç¨‹": true
          }
        }
        EOF
        
        # åˆ›å»ºè‡ªåŠ¨æ›´æ–°è®¾ç½®æ–‡ä»¶
        cat > ro_auto_update_settings.json << EOF
        {
          "auto_update_enabled": true,
          "last_update_date": "$(date -d '1 day ago' '+%Y-%m-%d')",
          "timer_enabled": false,
          "timer_interval": 1440
        }
        EOF
        
    - name: ðŸ¤– æ‰§è¡ŒROè‡ªåŠ¨æ›´æ–°
      run: |
        export DISPLAY=:99
        python -c "
        import sys
        import os
        import json
        from datetime import datetime, timedelta
        from integrated_auto_download_uploader import IntegratedAutoUploader
        from wechat_article_link_collector import WechatArticleLinkCollector
        
        print('ðŸš€ GitHub Actions - ROæ–‡ç« è‡ªåŠ¨æ›´æ–°å¼€å§‹')
        print('=' * 60)
        
        try:
            # åˆå§‹åŒ–é…ç½®
            app_id = os.getenv('FEISHU_APP_ID')
            app_secret = os.getenv('FEISHU_APP_SECRET')
            
            if not app_id or not app_secret:
                print('âŒ é£žä¹¦åº”ç”¨é…ç½®ç¼ºå¤±ï¼Œè¯·æ£€æŸ¥GitHub Secrets')
                sys.exit(1)
                
            print(f'âœ… é£žä¹¦åº”ç”¨é…ç½®å·²åŠ è½½')
            
            # æ­¥éª¤1: è®¡ç®—æ›´æ–°æ—¥æœŸèŒƒå›´
            print('ðŸ“… æ­¥éª¤1: è®¡ç®—æ›´æ–°æ—¥æœŸèŒƒå›´...')
            
            # è¯»å–ä¸Šæ¬¡æ›´æ–°æ—¥æœŸ
            try:
                with open('ro_auto_update_settings.json', 'r') as f:
                    settings = json.load(f)
                    last_date = settings.get('last_update_date')
            except:
                last_date = (datetime.now() - timedelta(days=1)).strftime('%Y-%m-%d')
            
            # èŽ·å–ä»Šå¤©æ—¥æœŸ
            today = datetime.now().strftime('%Y-%m-%d')
            
            # å¦‚æžœæ˜¯æ‰‹åŠ¨å¼ºåˆ¶æ›´æ–°ï¼Œæ‰©å¤§æ—¥æœŸèŒƒå›´
            force_update = '${{ github.event.inputs.force_update }}' == 'true'
            if force_update:
                print('ðŸ”„ æ£€æµ‹åˆ°å¼ºåˆ¶æ›´æ–°æ¨¡å¼ï¼Œæ‰©å¤§æ—¥æœŸèŒƒå›´')
                start_date = (datetime.now() - timedelta(days=7)).strftime('%Y-%m-%d')
            else:
                start_date = last_date
                
            end_date = today
            
            print(f'ðŸ“… æ›´æ–°æ—¥æœŸèŒƒå›´: {start_date} è‡³ {end_date}')
            
            # æ­¥éª¤2: åˆå§‹åŒ–é“¾æŽ¥æ”¶é›†å™¨
            print('ðŸ” æ­¥éª¤2: åˆå§‹åŒ–é“¾æŽ¥æ”¶é›†å™¨...')
            collector = WechatArticleLinkCollector(headless=True)
            
            # æ­¥éª¤3: æ”¶é›†æ–°æ–‡ç« 
            print(f'ðŸ“¥ æ­¥éª¤3: æ”¶é›†æ–°æ–‡ç«  ({start_date} è‡³ {end_date})...')
            
            try:
                # è‡ªåŠ¨ç™»å½•å’Œæœç´¢å…¬ä¼—å·
                login_success = collector.auto_login_and_search('ä»™å¢ƒä¼ è¯´ROæ–°å¯èˆª')
                if not login_success:
                    print('âŒ è‡ªåŠ¨ç™»å½•æˆ–æœç´¢å…¬ä¼—å·å¤±è´¥')
                    sys.exit(1)
                    
                # æ”¶é›†æ–‡ç« 
                articles = collector.collect_articles_by_date_range(
                    start_date=start_date,
                    end_date=end_date,
                    max_articles=50
                )
                
                print(f'ðŸ“Š æ”¶é›†åˆ° {len(articles)} ç¯‡æ–‡ç« ')
                
                if len(articles) == 0:
                    print('âœ… æ²¡æœ‰æ–°æ–‡ç« éœ€è¦æ›´æ–°')
                    # æ›´æ–°æœ€åŽæ£€æŸ¥æ—¥æœŸ
                    settings['last_update_date'] = today
                    with open('ro_auto_update_settings.json', 'w') as f:
                        json.dump(settings, f, indent=2, ensure_ascii=False)
                    sys.exit(0)
                    
            except Exception as e:
                print(f'âŒ æ”¶é›†æ–‡ç« æ—¶å‡ºé”™: {e}')
                sys.exit(1)
            finally:
                collector.cleanup()
            
            # æ­¥éª¤4: å¤„ç†æ–‡ç« ä¸‹è½½ä¸Šä¼ 
            print(f'ðŸ“š æ­¥éª¤4: å¤„ç†æ–‡ç« ä¸‹è½½ä¸Šä¼ ...')
            
            uploader = IntegratedAutoUploader(app_id, app_secret)
            
            success_count = 0
            total_count = len(articles)
            
            for i, article in enumerate(articles, 1):
                url = article.get('url')
                title = article.get('title', f'æ–‡ç« {i}')
                
                print(f'ðŸ“„ å¤„ç† {i}/{total_count}: {title[:30]}...')
                
                try:
                    result = uploader.process_single_url(url, format_type='pdf')
                    if result:
                        success_count += 1
                        print(f'   âœ… æˆåŠŸ')
                    else:
                        print(f'   âŒ å¤±è´¥')
                except Exception as e:
                    print(f'   âŒ å¤„ç†å‡ºé”™: {e}')
                    
            print(f'ðŸ“Š å¤„ç†å®Œæˆ: {success_count}/{total_count} æˆåŠŸ')
            
            # æ­¥éª¤5: æ›´æ–°è®¾ç½®
            print('ðŸ“… æ­¥éª¤5: æ›´æ–°æ£€æŸ¥æ—¥æœŸ...')
            settings['last_update_date'] = today
            with open('ro_auto_update_settings.json', 'w') as f:
                json.dump(settings, f, indent=2, ensure_ascii=False)
            
            print(f'ðŸŽ‰ ROè‡ªåŠ¨æ›´æ–°å®Œæˆï¼æˆåŠŸå¤„ç† {success_count}/{total_count} ç¯‡æ–‡ç« ')
            
        except Exception as e:
            print(f'âŒ è‡ªåŠ¨æ›´æ–°æ‰§è¡Œå¤±è´¥: {e}')
            import traceback
            traceback.print_exc()
            sys.exit(1)
        "
        
    - name: ðŸ“Š ä¸Šä¼ æ‰§è¡Œæ—¥å¿—
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: auto-update-logs-${{ github.run_number }}
        path: |
          logs/
          ro_auto_update_settings.json
          integrated_upload_log.json
        retention-days: 7
        
    - name: ðŸ“§ å‘é€é€šçŸ¥ï¼ˆå¯é€‰ï¼‰
      if: failure()
      run: |
        echo "âš ï¸ ROè‡ªåŠ¨æ›´æ–°å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ‰§è¡Œæ—¥å¿—"
        # è¿™é‡Œå¯ä»¥æ·»åŠ é‚®ä»¶æˆ–å…¶ä»–é€šçŸ¥é€»è¾‘ 