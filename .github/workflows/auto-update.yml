name: 🤖 RO文章自动更新

on:
  schedule:
    # 每天北京时间上午10:00执行 (UTC时间2:00)
    - cron: '0 2 * * *'
  
  # 支持手动触发
  workflow_dispatch:
    inputs:
      force_update:
        description: '强制执行更新（忽略日期检查）'
        required: false
        default: false
        type: boolean

env:
  # 从GitHub Secrets获取飞书应用配置
  FEISHU_APP_ID: ${{ secrets.FEISHU_APP_ID }}
  FEISHU_APP_SECRET: ${{ secrets.FEISHU_APP_SECRET }}
  FEISHU_ACCESS_TOKEN: ${{ secrets.FEISHU_ACCESS_TOKEN }}
  FEISHU_REFRESH_TOKEN: ${{ secrets.FEISHU_REFRESH_TOKEN }}

jobs:
  auto-update:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
    - name: 📥 检出代码
      uses: actions/checkout@v4
      
    - name: 🐍 设置Python环境
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        cache: 'pip'
        
    - name: 📦 安装依赖
      run: |
        pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: 🌐 安装Chrome浏览器
      run: |
        wget -q -O - https://dl.google.com/linux/linux_signing_key.pub | sudo apt-key add -
        sudo sh -c 'echo "deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main" >> /etc/apt/sources.list.d/google-chrome.list'
        sudo apt-get update
        sudo apt-get install -y google-chrome-stable
        
    - name: 🔧 配置虚拟显示器
      run: |
        sudo apt-get install -y xvfb
        export DISPLAY=:99
        Xvfb :99 -screen 0 1920x1080x24 > /dev/null 2>&1 &
        
    - name: 📁 创建必要目录
      run: |
        mkdir -p output/auto_download
        mkdir -p logs
        
    - name: 🔐 配置飞书认证信息
      run: |
        # 创建飞书OAuth令牌文件
        cat > feishu_oauth_tokens.json << EOF
        {
          "access_token": "${{ secrets.FEISHU_ACCESS_TOKEN }}",
          "refresh_token": "${{ secrets.FEISHU_REFRESH_TOKEN }}",
          "expires_in": 6900,
          "token_type": "Bearer",
          "scope": null,
          "created_at": $(date +%s),
          "app_id": "${{ secrets.FEISHU_APP_ID }}"
        }
        EOF
        
        # 创建用户配置文件
        cat > user_feishu_config.json << EOF
        {
          "app_id": "${{ secrets.FEISHU_APP_ID }}",
          "app_secret": "${{ secrets.FEISHU_APP_SECRET }}",
          "access_token": "${{ secrets.FEISHU_ACCESS_TOKEN }}",
          "space_token": "${{ secrets.FEISHU_SPACE_TOKEN }}",
          "space_id": "${{ secrets.FEISHU_SPACE_ID }}",
          "space_name": "仙境传说RO新启航公众号文章合集",
          "api_base": "https://open.feishu.cn/open-apis",
          "mode": "user_complete",
          "test_success": true,
          "test_time": "$(date '+%Y-%m-%d %H:%M:%S')",
          "capabilities": {
            "知识库权限": true,
            "云文档权限": true,
            "文件上传权限": true,
            "完整上传流程": true
          }
        }
        EOF
        
        # 创建自动更新设置文件
        cat > ro_auto_update_settings.json << EOF
        {
          "auto_update_enabled": true,
          "last_update_date": "$(date -d '1 day ago' '+%Y-%m-%d')",
          "timer_enabled": false,
          "timer_interval": 1440
        }
        EOF
        
    - name: 🤖 执行RO自动更新
      run: |
        export DISPLAY=:99
        python -c "
        import sys
        import os
        import json
        from datetime import datetime, timedelta
        from integrated_auto_download_uploader import IntegratedAutoUploader
        from wechat_article_link_collector import WechatArticleLinkCollector
        
        print('🚀 GitHub Actions - RO文章自动更新开始')
        print('=' * 60)
        
        try:
            # 初始化配置
            app_id = os.getenv('FEISHU_APP_ID')
            app_secret = os.getenv('FEISHU_APP_SECRET')
            
            if not app_id or not app_secret:
                print('❌ 飞书应用配置缺失，请检查GitHub Secrets')
                sys.exit(1)
                
            print(f'✅ 飞书应用配置已加载')
            
            # 步骤1: 计算更新日期范围
            print('📅 步骤1: 计算更新日期范围...')
            
            # 读取上次更新日期
            try:
                with open('ro_auto_update_settings.json', 'r') as f:
                    settings = json.load(f)
                    last_date = settings.get('last_update_date')
            except:
                last_date = (datetime.now() - timedelta(days=1)).strftime('%Y-%m-%d')
            
            # 获取今天日期
            today = datetime.now().strftime('%Y-%m-%d')
            
            # 如果是手动强制更新，扩大日期范围
            force_update = '${{ github.event.inputs.force_update }}' == 'true'
            if force_update:
                print('🔄 检测到强制更新模式，扩大日期范围')
                start_date = (datetime.now() - timedelta(days=7)).strftime('%Y-%m-%d')
            else:
                start_date = last_date
                
            end_date = today
            
            print(f'📅 更新日期范围: {start_date} 至 {end_date}')
            
            # 步骤2: 初始化链接收集器
            print('🔍 步骤2: 初始化链接收集器...')
            collector = WechatArticleLinkCollector(headless=True)
            
            # 步骤3: 收集新文章
            print(f'📥 步骤3: 收集新文章 ({start_date} 至 {end_date})...')
            
            try:
                # 自动登录和搜索公众号
                login_success = collector.auto_login_and_search('仙境传说RO新启航')
                if not login_success:
                    print('❌ 自动登录或搜索公众号失败')
                    sys.exit(1)
                    
                # 收集文章
                articles = collector.collect_articles_by_date_range(
                    start_date=start_date,
                    end_date=end_date,
                    max_articles=50
                )
                
                print(f'📊 收集到 {len(articles)} 篇文章')
                
                if len(articles) == 0:
                    print('✅ 没有新文章需要更新')
                    # 更新最后检查日期
                    settings['last_update_date'] = today
                    with open('ro_auto_update_settings.json', 'w') as f:
                        json.dump(settings, f, indent=2, ensure_ascii=False)
                    sys.exit(0)
                    
            except Exception as e:
                print(f'❌ 收集文章时出错: {e}')
                sys.exit(1)
            finally:
                collector.cleanup()
            
            # 步骤4: 处理文章下载上传
            print(f'📚 步骤4: 处理文章下载上传...')
            
            uploader = IntegratedAutoUploader(app_id, app_secret)
            
            success_count = 0
            total_count = len(articles)
            
            for i, article in enumerate(articles, 1):
                url = article.get('url')
                title = article.get('title', f'文章{i}')
                
                print(f'📄 处理 {i}/{total_count}: {title[:30]}...')
                
                try:
                    result = uploader.process_single_url(url, format_type='pdf')
                    if result:
                        success_count += 1
                        print(f'   ✅ 成功')
                    else:
                        print(f'   ❌ 失败')
                except Exception as e:
                    print(f'   ❌ 处理出错: {e}')
                    
            print(f'📊 处理完成: {success_count}/{total_count} 成功')
            
            # 步骤5: 更新设置
            print('📅 步骤5: 更新检查日期...')
            settings['last_update_date'] = today
            with open('ro_auto_update_settings.json', 'w') as f:
                json.dump(settings, f, indent=2, ensure_ascii=False)
            
            print(f'🎉 RO自动更新完成！成功处理 {success_count}/{total_count} 篇文章')
            
        except Exception as e:
            print(f'❌ 自动更新执行失败: {e}')
            import traceback
            traceback.print_exc()
            sys.exit(1)
        "
        
    - name: 📊 上传执行日志
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: auto-update-logs-${{ github.run_number }}
        path: |
          logs/
          ro_auto_update_settings.json
          integrated_upload_log.json
        retention-days: 7
        
    - name: 📧 发送通知（可选）
      if: failure()
      run: |
        echo "⚠️ RO自动更新失败，请检查执行日志"
        # 这里可以添加邮件或其他通知逻辑 