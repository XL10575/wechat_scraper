name: Auto Update RO Articles Enhanced

on:
  schedule:
    # æ¯å¤©åŒ—äº¬æ—¶é—´10:00è¿è¡Œ (UTC 02:00)
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      force_update:
        description: 'å¼ºåˆ¶æ›´æ–°ï¼ˆæ”¶é›†æœ€è¿‘7å¤©çš„æ–‡ç« ï¼‰'
        required: false
        default: false
        type: boolean
      max_articles:
        description: 'æœ€å¤§æ–‡ç« æ•°é‡'
        required: false
        default: '30'
        type: string

jobs:
  auto-update:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: Restore WeChat login state
      run: |
        # æ¢å¤cookies
        echo "${{ secrets.WECHAT_COOKIES_B64 }}" | base64 -d > wechat_cookies.pkl
        
        # æ¢å¤ä¼šè¯ä¿¡æ¯
        cat > wechat_session.json << 'EOF'
        {
          "user_agent": "${{ secrets.WECHAT_USER_AGENT }}",
          "login_time": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
          "restored_from_secrets": true
        }
        EOF
        
        echo "âœ… å¾®ä¿¡ç™»å½•çŠ¶æ€å·²æ¢å¤"
        
    - name: Auto collect WeChat articles
      run: |
        python -c "
        from headless_wechat_collector import HeadlessWeChatCollector
        from datetime import datetime, timedelta
        import json
        import os
        
        # è·å–è¾“å…¥å‚æ•°
        force_update = '${{ github.event.inputs.force_update }}' == 'true'
        max_articles = int('${{ github.event.inputs.max_articles }}' or '30')
        
        print(f'ğŸš€ å¼€å§‹è‡ªåŠ¨æ”¶é›†å¾®ä¿¡æ–‡ç« ...')
        print(f'ğŸ“Š å‚æ•°: å¼ºåˆ¶æ›´æ–°={force_update}, æœ€å¤§æ–‡ç« æ•°={max_articles}')
        
        # åˆ›å»ºæ”¶é›†å™¨
        collector = HeadlessWeChatCollector()
        
        # ç¡®å®šæ”¶é›†æ—¶é—´èŒƒå›´
        if force_update:
            days_back = 7
            print('ğŸ”„ å¼ºåˆ¶æ›´æ–°æ¨¡å¼: æ”¶é›†æœ€è¿‘7å¤©çš„æ–‡ç« ')
        else:
            # æ£€æŸ¥ä¸Šæ¬¡æ›´æ–°æ—¶é—´
            try:
                with open('ro_auto_update_settings.json', 'r', encoding='utf-8') as f:
                    settings = json.load(f)
                    last_update = datetime.fromisoformat(settings.get('last_update', '2025-01-01T00:00:00'))
                    days_since_update = (datetime.now() - last_update).days
                    days_back = min(max(days_since_update + 1, 1), 30)  # è‡³å°‘1å¤©ï¼Œæœ€å¤š30å¤©
                    print(f'ğŸ“… ä¸Šæ¬¡æ›´æ–°: {last_update.strftime(\"%Y-%m-%d %H:%M:%S\")}')
                    print(f'ğŸ“… æ”¶é›†æœ€è¿‘ {days_back} å¤©çš„æ–‡ç« ')
            except:
                days_back = 7
                print('ğŸ“… é¦–æ¬¡è¿è¡Œï¼Œæ”¶é›†æœ€è¿‘7å¤©çš„æ–‡ç« ')
        
        # è‡ªåŠ¨æ”¶é›†æ–‡ç« 
        articles = collector.auto_collect_articles(
            account_name='ä»™å¢ƒä¼ è¯´ROæ–°å¯èˆª',
            days_back=days_back,
            max_articles=max_articles
        )
        
        print(f'âœ… æ”¶é›†å®Œæˆ: {len(articles)} ç¯‡æ–‡ç« ')
        
        if articles:
            # ä¿å­˜æ–‡ç« URLåˆ°æ–‡ä»¶
            urls = [article['url'] for article in articles if article.get('url')]
            
            # ç¡®ä¿è¾“å‡ºç›®å½•å­˜åœ¨
            os.makedirs('output', exist_ok=True)
            
            with open('output/collected_urls.txt', 'w', encoding='utf-8') as f:
                for url in urls:
                    f.write(url + '\n')
            
            print(f'ğŸ“„ å·²ä¿å­˜ {len(urls)} ä¸ªæ–‡ç« URLåˆ° output/collected_urls.txt')
            
            # æ˜¾ç¤ºæ”¶é›†åˆ°çš„æ–‡ç« 
            print('\nğŸ“‹ æ”¶é›†åˆ°çš„æ–‡ç« :')
            for i, article in enumerate(articles[:10], 1):
                title = article.get('title', 'æ— æ ‡é¢˜')[:60]
                publish_time = article.get('publish_time', 'æœªçŸ¥æ—¶é—´')
                print(f'  {i}. {title}... - {publish_time}')
            
            if len(articles) > 10:
                print(f'  ... è¿˜æœ‰ {len(articles) - 10} ç¯‡æ–‡ç« ')
        else:
            print('âš ï¸ æœªæ”¶é›†åˆ°ä»»ä½•æ–‡ç« ')
            # åˆ›å»ºç©ºæ–‡ä»¶é¿å…åç»­æ­¥éª¤å‡ºé”™
            os.makedirs('output', exist_ok=True)
            with open('output/collected_urls.txt', 'w') as f:
                pass
        
        # è®¾ç½®è¾“å‡ºå˜é‡
        with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
            f.write(f'articles_count={len(articles)}\n')
            f.write(f'has_articles={\"true\" if articles else \"false\"}\n')
        "
      id: collect_articles
      
    - name: Process collected articles
      if: steps.collect_articles.outputs.has_articles == 'true'
      run: |
        echo "ğŸ“¥ å¼€å§‹å¤„ç†æ”¶é›†åˆ°çš„æ–‡ç« ..."
        
        # æ£€æŸ¥æ˜¯å¦æœ‰URLæ–‡ä»¶
        if [ ! -f "output/collected_urls.txt" ] || [ ! -s "output/collected_urls.txt" ]; then
          echo "âŒ æ²¡æœ‰æ‰¾åˆ°æ–‡ç« URLæ–‡ä»¶æˆ–æ–‡ä»¶ä¸ºç©º"
          exit 1
        fi
        
        # ç»Ÿè®¡URLæ•°é‡
        url_count=$(wc -l < output/collected_urls.txt)
        echo "ğŸ“Š å…±æœ‰ $url_count ä¸ªæ–‡ç« URLå¾…å¤„ç†"
        
        # è¿è¡Œé›†æˆä¸‹è½½ä¸Šä¼ å™¨
        python integrated_auto_download_uploader.py \
          --input output/collected_urls.txt \
          --max-files ${{ steps.collect_articles.outputs.articles_count }} \
          --auto-mode
        
        echo "âœ… æ–‡ç« å¤„ç†å®Œæˆ"
        
    - name: Update settings and statistics
      run: |
        python -c "
        import json
        from datetime import datetime
        import os
        
        # è¯»å–å½“å‰è®¾ç½®
        settings_file = 'ro_auto_update_settings.json'
        try:
            with open(settings_file, 'r', encoding='utf-8') as f:
                settings = json.load(f)
        except:
            settings = {}
        
        # æ›´æ–°è®¾ç½®
        current_time = datetime.now()
        articles_count = int('${{ steps.collect_articles.outputs.articles_count }}')
        
        settings.update({
            'last_update': current_time.isoformat(),
            'last_run_articles_count': articles_count,
            'total_runs': settings.get('total_runs', 0) + 1,
            'total_articles_collected': settings.get('total_articles_collected', 0) + articles_count,
            'last_run_mode': 'å¼ºåˆ¶æ›´æ–°' if '${{ github.event.inputs.force_update }}' == 'true' else 'è‡ªåŠ¨æ›´æ–°',
            'github_actor': '${{ github.actor }}',
            'workflow_run_id': '${{ github.run_id }}'
        })
        
        # ä¿å­˜è®¾ç½®
        with open(settings_file, 'w', encoding='utf-8') as f:
            json.dump(settings, f, ensure_ascii=False, indent=2)
        
        print(f'ğŸ“Š è¿è¡Œç»Ÿè®¡:')
        print(f'  - æœ¬æ¬¡æ”¶é›†: {articles_count} ç¯‡æ–‡ç« ')
        print(f'  - æ€»è¿è¡Œæ¬¡æ•°: {settings[\"total_runs\"]}')
        print(f'  - ç´¯è®¡æ”¶é›†: {settings[\"total_articles_collected\"]} ç¯‡æ–‡ç« ')
        print(f'  - è¿è¡Œæ¨¡å¼: {settings[\"last_run_mode\"]}')
        print(f'  - æ›´æ–°æ—¶é—´: {current_time.strftime(\"%Y-%m-%d %H:%M:%S\")}')
        "
        
    - name: Cleanup temporary files
      run: |
        # æ¸…ç†æ•æ„Ÿæ–‡ä»¶
        rm -f wechat_cookies.pkl
        rm -f wechat_session.json
        
        # ä¿ç•™æ—¥å¿—æ–‡ä»¶ä½†æ¸…ç†ä¸´æ—¶æ–‡ä»¶
        find . -name "*.tmp" -delete 2>/dev/null || true
        find . -name "__pycache__" -type d -exec rm -rf {} + 2>/dev/null || true
        
        echo "ğŸ§¹ ä¸´æ—¶æ–‡ä»¶æ¸…ç†å®Œæˆ"
        
    - name: Summary
      run: |
        echo "ğŸ‰ è‡ªåŠ¨æ›´æ–°ä»»åŠ¡å®Œæˆï¼"
        echo ""
        echo "ğŸ“Š æœ¬æ¬¡è¿è¡Œæ€»ç»“:"
        echo "  - æ”¶é›†æ–‡ç« æ•°é‡: ${{ steps.collect_articles.outputs.articles_count }}"
        echo "  - å¤„ç†çŠ¶æ€: ${{ steps.collect_articles.outputs.has_articles == 'true' && 'âœ… æˆåŠŸ' || 'âš ï¸ æ— æ–°æ–‡ç« ' }}"
        echo "  - è¿è¡Œæ—¶é—´: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
        echo "  - è§¦å‘æ–¹å¼: ${{ github.event_name == 'schedule' && 'å®šæ—¶ä»»åŠ¡' || 'æ‰‹åŠ¨è§¦å‘' }}"
        
        if [ "${{ steps.collect_articles.outputs.has_articles }}" = "true" ]; then
          echo ""
          echo "âœ… æ–‡ç« å·²æˆåŠŸæ”¶é›†å¹¶ä¸Šä¼ åˆ°é£ä¹¦çŸ¥è¯†åº“"
        else
          echo ""
          echo "â„¹ï¸ æœ¬æ¬¡è¿è¡Œæœªæ”¶é›†åˆ°æ–°æ–‡ç« ï¼Œè¿™å¯èƒ½æ˜¯æ­£å¸¸çš„"
        fi 