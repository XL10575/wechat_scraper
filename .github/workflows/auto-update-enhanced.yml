name: ğŸ¤– ROæ–‡ç« è‡ªåŠ¨æ›´æ–° (å¢å¼ºç‰ˆ)

on:
  schedule:
    # æ¯å¤©åŒ—äº¬æ—¶é—´ä¸Šåˆ10:00æ‰§è¡Œ (UTCæ—¶é—´2:00)
    - cron: '0 2 * * *'
  
  # æ”¯æŒæ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      force_update:
        description: 'å¼ºåˆ¶æ‰§è¡Œæ›´æ–°ï¼ˆå¿½ç•¥æ—¥æœŸæ£€æŸ¥ï¼‰'
        required: false
        default: false
        type: boolean
      days_back:
        description: 'æ”¶é›†æœ€è¿‘å‡ å¤©çš„æ–‡ç« '
        required: false
        default: '7'
        type: string

env:
  # ä»GitHub Secretsè·å–é£ä¹¦åº”ç”¨é…ç½®
  FEISHU_APP_ID: ${{ secrets.FEISHU_APP_ID }}
  FEISHU_APP_SECRET: ${{ secrets.FEISHU_APP_SECRET }}
  FEISHU_ACCESS_TOKEN: ${{ secrets.FEISHU_ACCESS_TOKEN }}
  FEISHU_REFRESH_TOKEN: ${{ secrets.FEISHU_REFRESH_TOKEN }}
  FEISHU_SPACE_TOKEN: ${{ secrets.FEISHU_SPACE_TOKEN }}
  FEISHU_SPACE_ID: ${{ secrets.FEISHU_SPACE_ID }}
  # å¾®ä¿¡ç™»å½•çŠ¶æ€
  WECHAT_COOKIES_B64: ${{ secrets.WECHAT_COOKIES_B64 }}
  WECHAT_USER_AGENT: ${{ secrets.WECHAT_USER_AGENT }}

jobs:
  auto-update:
    runs-on: ubuntu-latest
    timeout-minutes: 45
    
    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: ğŸ è®¾ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'
        
    - name: ğŸ“¦ å®‰è£…ä¾èµ–
      run: |
        pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: ğŸŒ å®‰è£…Chromeæµè§ˆå™¨
      run: |
        wget -q -O - https://dl.google.com/linux/linux_signing_key.pub | sudo apt-key add -
        sudo sh -c 'echo "deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main" >> /etc/apt/sources.list.d/google-chrome.list'
        sudo apt-get update
        sudo apt-get install -y google-chrome-stable
        
    - name: ğŸ”§ é…ç½®è™šæ‹Ÿæ˜¾ç¤ºå™¨
      run: |
        sudo apt-get install -y xvfb
        export DISPLAY=:99
        Xvfb :99 -screen 0 1920x1080x24 > /dev/null 2>&1 &
        
    - name: ğŸ“ åˆ›å»ºå¿…è¦ç›®å½•
      run: |
        mkdir -p output/auto_download
        mkdir -p logs
        
    - name: ğŸ” é…ç½®é£ä¹¦è®¤è¯ä¿¡æ¯å’Œå¾®ä¿¡ç™»å½•çŠ¶æ€
      run: |
        # åˆ›å»ºé£ä¹¦OAuthä»¤ç‰Œæ–‡ä»¶
        cat > feishu_oauth_tokens.json << EOF
        {
          "access_token": "${{ secrets.FEISHU_ACCESS_TOKEN }}",
          "refresh_token": "${{ secrets.FEISHU_REFRESH_TOKEN }}",
          "expires_in": 6900,
          "token_type": "Bearer",
          "scope": null,
          "created_at": $(date +%s),
          "app_id": "${{ secrets.FEISHU_APP_ID }}"
        }
        EOF
        
        # åˆ›å»ºå¾®ä¿¡ç™»å½•çŠ¶æ€æ–‡ä»¶
        if [ -n "${{ secrets.WECHAT_COOKIES_B64 }}" ]; then
          echo "ğŸ” æ¢å¤å¾®ä¿¡ç™»å½•çŠ¶æ€..."
          echo "${{ secrets.WECHAT_COOKIES_B64 }}" | base64 -d > wechat_cookies.pkl
          
          cat > wechat_session.json << EOF
        {
          "user_agent": "${{ secrets.WECHAT_USER_AGENT }}",
          "timestamp": $(date +%s),
          "login_success": true,
          "restored_from_github": true
        }
        EOF
          echo "âœ… å¾®ä¿¡ç™»å½•çŠ¶æ€å·²æ¢å¤"
        else
          echo "âš ï¸ æœªæ‰¾åˆ°å¾®ä¿¡ç™»å½•çŠ¶æ€ï¼Œå¯èƒ½éœ€è¦é‡æ–°ç™»å½•"
          exit 1
        fi
        
        # åˆ›å»ºç”¨æˆ·é…ç½®æ–‡ä»¶
        cat > user_feishu_config.json << EOF
        {
          "app_id": "${{ secrets.FEISHU_APP_ID }}",
          "app_secret": "${{ secrets.FEISHU_APP_SECRET }}",
          "access_token": "${{ secrets.FEISHU_ACCESS_TOKEN }}",
          "space_token": "${{ secrets.FEISHU_SPACE_TOKEN }}",
          "space_id": "${{ secrets.FEISHU_SPACE_ID }}",
          "space_name": "ä»™å¢ƒä¼ è¯´ROæ–°å¯èˆªå…¬ä¼—å·æ–‡ç« åˆé›†",
          "api_base": "https://open.feishu.cn/open-apis",
          "mode": "user_complete",
          "test_success": true,
          "test_time": "$(date '+%Y-%m-%d %H:%M:%S')",
          "capabilities": {
            "çŸ¥è¯†åº“æƒé™": true,
            "äº‘æ–‡æ¡£æƒé™": true,
            "æ–‡ä»¶ä¸Šä¼ æƒé™": true,
            "å®Œæ•´ä¸Šä¼ æµç¨‹": true
          }
        }
        EOF
        
    - name: ğŸ§ª æµ‹è¯•æ–‡ç« æ”¶é›†åŠŸèƒ½
      run: |
        export DISPLAY=:99
        python -c "
        import sys
        import os
        from datetime import datetime, timedelta
        from headless_wechat_collector import HeadlessWeChatCollector
        
        print('ğŸ§ª æµ‹è¯•æ–‡ç« æ”¶é›†åŠŸèƒ½')
        print('=' * 50)
        
        try:
            # è·å–å‚æ•°
            days_back = int('${{ github.event.inputs.days_back }}' or '7')
            force_update = '${{ github.event.inputs.force_update }}' == 'true'
            
            if force_update:
                days_back = max(days_back, 14)  # å¼ºåˆ¶æ›´æ–°æ—¶è‡³å°‘æ”¶é›†14å¤©
            
            print(f'ğŸ“… æ”¶é›†èŒƒå›´: æœ€è¿‘ {days_back} å¤©')
            print(f'ğŸ”„ å¼ºåˆ¶æ›´æ–°: {force_update}')
            
            # åˆå§‹åŒ–æ”¶é›†å™¨
            collector = HeadlessWeChatCollector()
            
            # æµ‹è¯•æ”¶é›†
            articles = collector.auto_collect_articles(
                account_name='ä»™å¢ƒä¼ è¯´ROæ–°å¯èˆª',
                days_back=days_back,
                max_articles=100
            )
            
            print(f'ğŸ“Š æ”¶é›†ç»“æœ: {len(articles)} ç¯‡æ–‡ç« ')
            
            if articles:
                print('ğŸ“ æ–‡ç« åˆ—è¡¨:')
                for i, article in enumerate(articles[:5], 1):
                    title = article.get('title', 'æ— æ ‡é¢˜')[:50]
                    publish_time = article.get('publish_time', 'æœªçŸ¥æ—¶é—´')
                    print(f'  {i}. {title}... ({publish_time})')
                
                # ä¿å­˜æ”¶é›†ç»“æœ
                import json
                with open('collected_articles.json', 'w', encoding='utf-8') as f:
                    json.dump(articles, f, indent=2, ensure_ascii=False)
                
                print('âœ… æ–‡ç« æ”¶é›†æˆåŠŸï¼Œå·²ä¿å­˜åˆ° collected_articles.json')
            else:
                print('âŒ æ²¡æœ‰æ”¶é›†åˆ°æ–‡ç« ')
                print('ğŸ” å¯èƒ½çš„åŸå› :')
                print('  1. æŒ‡å®šæ—¶é—´èŒƒå›´å†…æ²¡æœ‰æ–°æ–‡ç« ')
                print('  2. å¾®ä¿¡ç™»å½•çŠ¶æ€å·²è¿‡æœŸ')
                print('  3. ç½‘ç»œè¿æ¥é—®é¢˜')
                print('  4. å¾®ä¿¡APIå˜æ›´')
                
                # å°è¯•æ›´å¤§çš„æ—¶é—´èŒƒå›´
                if days_back < 30:
                    print(f'ğŸ”„ å°è¯•æ‰©å¤§åˆ°30å¤©èŒƒå›´...')
                    articles = collector.auto_collect_articles(
                        account_name='ä»™å¢ƒä¼ è¯´ROæ–°å¯èˆª',
                        days_back=30,
                        max_articles=50
                    )
                    
                    if articles:
                        print(f'âœ… æ‰©å¤§èŒƒå›´åæ”¶é›†åˆ° {len(articles)} ç¯‡æ–‡ç« ')
                        import json
                        with open('collected_articles.json', 'w', encoding='utf-8') as f:
                            json.dump(articles, f, indent=2, ensure_ascii=False)
                    else:
                        print('âŒ æ‰©å¤§èŒƒå›´åä»æ— æ”¶é›†ç»“æœ')
                        sys.exit(1)
                
        except Exception as e:
            print(f'âŒ æµ‹è¯•å¤±è´¥: {e}')
            import traceback
            traceback.print_exc()
            sys.exit(1)
        "
        
    - name: ğŸ¤– å¤„ç†æ”¶é›†åˆ°çš„æ–‡ç« 
      if: success()
      run: |
        export DISPLAY=:99
        python -c "
        import sys
        import os
        import json
        from datetime import datetime
        from integrated_auto_download_uploader import IntegratedAutoUploader
        
        print('ğŸš€ å¤„ç†æ”¶é›†åˆ°çš„æ–‡ç« ')
        print('=' * 50)
        
        try:
            # æ£€æŸ¥æ˜¯å¦æœ‰æ”¶é›†åˆ°çš„æ–‡ç« 
            if not os.path.exists('collected_articles.json'):
                print('âŒ æœªæ‰¾åˆ°æ”¶é›†çš„æ–‡ç« æ–‡ä»¶')
                sys.exit(1)
            
            # è¯»å–æ–‡ç« åˆ—è¡¨
            with open('collected_articles.json', 'r', encoding='utf-8') as f:
                articles = json.load(f)
            
            if not articles:
                print('âŒ æ–‡ç« åˆ—è¡¨ä¸ºç©º')
                sys.exit(1)
            
            print(f'ğŸ“š å¼€å§‹å¤„ç† {len(articles)} ç¯‡æ–‡ç« ')
            
            # åˆå§‹åŒ–ä¸Šä¼ å™¨
            app_id = os.getenv('FEISHU_APP_ID')
            app_secret = os.getenv('FEISHU_APP_SECRET')
            
            if not app_id or not app_secret:
                print('âŒ é£ä¹¦åº”ç”¨é…ç½®ç¼ºå¤±')
                sys.exit(1)
            
            uploader = IntegratedAutoUploader(app_id, app_secret)
            
            success_count = 0
            total_count = len(articles)
            
            for i, article in enumerate(articles, 1):
                url = article.get('url')
                title = article.get('title', f'æ–‡ç« {i}')
                
                if not url:
                    print(f'âš ï¸ ç¬¬{i}ç¯‡æ–‡ç« ç¼ºå°‘URLï¼Œè·³è¿‡')
                    continue
                
                print(f'ğŸ“„ å¤„ç† {i}/{total_count}: {title[:40]}...')
                print(f'   URL: {url[:80]}...')
                
                try:
                    result = uploader.process_single_url(url, format_type='pdf')
                    if result:
                        success_count += 1
                        print(f'   âœ… æˆåŠŸä¸Šä¼ åˆ°é£ä¹¦')
                    else:
                        print(f'   âŒ ä¸Šä¼ å¤±è´¥')
                except Exception as e:
                    print(f'   âŒ å¤„ç†å‡ºé”™: {e}')
                    
                # é¿å…è¿‡å¿«è¯·æ±‚
                if i < total_count:
                    print(f'   â³ ç­‰å¾… 3 ç§’...')
                    import time
                    time.sleep(3)
                    
            print(f'ğŸ“Š å¤„ç†å®Œæˆ: {success_count}/{total_count} æˆåŠŸ')
            
            # æ›´æ–°è®¾ç½®æ–‡ä»¶
            settings = {
                'last_update_date': datetime.now().strftime('%Y-%m-%d'),
                'last_check_time': datetime.now().isoformat(),
                'processed_count': success_count,
                'total_count': total_count,
                'status': 'completed',
                'articles_collected': len(articles),
                'success_rate': f'{success_count}/{total_count}' if total_count > 0 else '0/0'
            }
            
            with open('ro_auto_update_settings.json', 'w', encoding='utf-8') as f:
                json.dump(settings, f, indent=2, ensure_ascii=False)
            
            print(f'ğŸ‰ è‡ªåŠ¨æ›´æ–°å®Œæˆï¼')
            print(f'ğŸ“Š æ”¶é›†æ–‡ç« : {len(articles)} ç¯‡')
            print(f'ğŸ“Š æˆåŠŸä¸Šä¼ : {success_count}/{total_count} ç¯‡')
            print(f'ğŸ“Š æˆåŠŸç‡: {success_count/total_count*100:.1f}%' if total_count > 0 else 'ğŸ“Š æˆåŠŸç‡: 0%')
            
        except Exception as e:
            print(f'âŒ å¤„ç†æ–‡ç« å¤±è´¥: {e}')
            import traceback
            traceback.print_exc()
            sys.exit(1)
        "
        
    - name: ğŸ“Š ä¸Šä¼ æ‰§è¡Œæ—¥å¿—å’Œç»“æœ
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: auto-update-enhanced-logs-${{ github.run_number }}
        path: |
          logs/
          ro_auto_update_settings.json
          collected_articles.json
        retention-days: 7 